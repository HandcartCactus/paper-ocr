<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Viewer with OCR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
    }
    #pdf-viewer {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    #side-panel {
      width: 300px;
      padding: 20px;
      background-color: #f0f0f0;
      overflow-y: auto;
      position: fixed;
      right: 0;
    }
    .page-container {
      margin-bottom: 20px;
      position: relative;
    }
    .ocr-button {
      margin-top: 10px;
    }
    .bounding-box {
      position: absolute;
      border: 2px solid red;
      cursor: pointer;
    }
    #selected-text {
      margin-top: 20px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div id="pdf-viewer">
    <input type="file" id="pdf-file" accept=".pdf">
    <div id="pdf-pages"></div>
  </div>
  <div id="side-panel">
    <h2>Selected Text</h2>
    <div id="selected-text"></div>
  </div>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js';

    const pdfFile = document.getElementById('pdf-file');
    const pdfPages = document.getElementById('pdf-pages');
    const selectedText = document.getElementById('selected-text');

    pdfFile.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;

      pdfPages.innerHTML = '';

      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const scale = 1.5;
        const viewport = page.getViewport({ scale });

        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        const renderContext = {
          canvasContext: context,
          viewport: viewport
        };

        await page.render(renderContext);

        const pageContainer = document.createElement('div');
        pageContainer.className = 'page-container';
        pageContainer.appendChild(canvas);

        const ocrButton = document.createElement('button');
        ocrButton.textContent = `OCR Page ${pageNum}`;
        ocrButton.className = 'ocr-button';
        ocrButton.addEventListener('click', () => performOCR(canvas, pageContainer));

        pageContainer.appendChild(ocrButton);
        pdfPages.appendChild(pageContainer);
      }
    });

    async function performOCR(canvas, pageContainer) {
      const formData = new FormData();
      formData.append('image', await canvasToBlob(canvas), 'page.png');
      formData.append('two_col', 'true');

      try {
        const response = await fetch('/ocr', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error('OCR request failed');
        }

        const data = await response.json();
        drawBoundingBoxes(data.bounding_boxes, pageContainer, canvas);
      } catch (error) {
        console.error('Error performing OCR:', error);
      }
    }

    function canvasToBlob(canvas) {
      return new Promise((resolve) => {
        canvas.toBlob(resolve, 'image/png');
      });
    }

    function drawBoundingBoxes(boxes, pageContainer, canvas) {
      boxes.forEach(box => {
        const boundingBox = document.createElement('div');
        boundingBox.className = 'bounding-box';
        boundingBox.style.left = `${box.x * canvas.width}px`;
        boundingBox.style.top = `${box.y * canvas.height}px`;
        boundingBox.style.width = `${box.w * canvas.width}px`;
        boundingBox.style.height = `${box.h * canvas.height}px`;
        boundingBox.addEventListener('click', () => {
          selectedText.textContent = box.text;
        });
        pageContainer.appendChild(boundingBox);
      });
    }
  </script>
</body>
</html>